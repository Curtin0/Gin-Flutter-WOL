# 上位机与串口设备2通信modbus

## 1  从站地址

上位机控制的串口设备的有效地址

风机控制器的地址范围为0x21~0x28，共8个连续的实际设备物理地址。

每个上位机连接8个风机控制器，风机控制器地址超过八个后无法区分，故数据上传服务器时需通过上位机ID+风机设备物理地址进行区分。

## 2  数据传输格式

### 2.1 上位机->串口设备

从站地址见1解释

| 1读取指令(总7字节) | 帧头 | 从站地址 | 功能码 | 固定格式   | 校验码 | 帧尾   |
| ------------------ | ---- | -------- | ------ | ---------- | ------ | ------ |
| 描述   （例如）    | (空) | 0x21     | 0x03   | 0x0000000C | 0xXXXX | （空） |
| 长度   （byte）    | 0    | 1        | 1      | 4          | 2      | 0      |

| 2操作指令(总15字节) | 帧头 | 从站地址 | 功能码 | 固定格式   | 参数长度 | 下发参数  | 校验码 | 帧尾   |
| ------------------- | ---- | -------- | ------ | ---------- | -------- | --------- | ------ | ------ |
| 描述   （例如）     | (空) | 0x21     | 0x10   | 0x00000003 | 0x06     | 见3.1列表 | 0xXXXX | （空） |
| 长度   （byte）     | 0    | 1        | 1      | 4          | 1        | 6         | 2      | 0      |

------

### 2.2  串口设备->上位机

| 1读取指令(总31字节) | 帧头 | 从站地址 | 功能码 | 参数长度 | 上传参数  | 校验码 | 帧尾 |
| ------------------- | ---- | -------- | ------ | -------- | --------- | ------ | ---- |
| 描述                | (空) | 0x21     | 0x03   | 0x1A     | 见3.3列表 | 0xXXXX | (空) |
| 长度(byte)          | 0    | 1        | 1      | 1        | 26        | 2      | 0    |

| 2操作指令(总8字节) | 帧头 | 从站地址 | 功能码 | 固定格式   | 校验码 | 帧尾   |
| ------------------ | ---- | -------- | -----: | ---------- | ------ | ------ |
| 描述   （例如）    | (空) | 0x21     |   0x10 | 0x00000003 | 0xXXXX | （空） |
| 长度   （byte）    | 0    | 1        |      1 | 4          | 2      | 0      |

## 3  数据传输流程

上位机对串口数据的处理

##### 3.1 下发参数解释

| 序号 | 数据定义   | 数据类型 | 数据说明                                                     | 单位  |
| ---- | ---------- | -------- | ------------------------------------------------------------ | ----- |
| 1    | 输入源选择 | uint8_t  | 0x00  自动识别;  0x01 DC110V ; 0x02 DC600V ; 0x03  AC380V ;  |       |
| 2    | 运行模式   | uint8_t  | 0x00  停机 ;  0x01 执行设置转速参数调速  ;  0x02  根据风量等级进行调速 ; 0x03  0-10V电压调速 |       |
| 3    | 风量等级   | uint16_t | *0x0003* （3级风量）                                         | level |
| 4    | 设置转速   | int16_t  | *0x03E8**（1000**转），负数表示反转*                         | rpm   |

##### 3.2  正式运行指令  服务器 -> 上位机 -> 串口 -> 上位机 -> 服务器

##### 3.3 上传参数解释

| 序号 | 定义          | 类型     | 数据说明                                                     | 单位 |
| ---- | ------------- | -------- | ------------------------------------------------------------ | ---- |
| 1    | 当前状态      | uint16_t | 0x0000 空闲；0x0001 启动；0x0002 运行；0x0003 故障；0x0004 故障死锁；0x0005 停机 |      |
| 2    | 输入源        | uint8_t  | 0x00 未识别或者欠压; 0x01 DC110V; 0x02 DC600V; 0x03 AC380V   |      |
| 3    | 运行模式      | uint8_t  | 0x00 停机; 0x01 按“设置转速”运行;0x02 按“风量等级”运行; 0x03按“电压调速”运行 |      |
| 4    | 风机转速      | int16_t  | *eg.: 0x03E8（1000转）*                                      | rpm  |
| 5    | NTC温度       | int16_t  | *eg.: 0x0028（40摄氏度）*                                    | ℃    |
| 6    | 母线电压      | uint16_  | *eg.: 0x006E（110V）*                                        | V    |
| 7    | U相电流       | uint16_t | *eg.: 0x0BB8（3000mA有效值）*                                | mA   |
| 8    | V相电流       | uint16_t | *eg.: 0x0BB8（3000mA有效值）*                                | mA   |
| 9    | W相电流       | uint16_t | *eg.: 0x0BB8（3000mA有效值）*                                | mA   |
| 10   | 运行时间      | uint32_t | *eg.:0x00004E20（20000s累计运行时间）*                       | s    |
| 11   | 软件版本      | Uint32_t | *eg.:0x00010203(版本号：V1.23)*                              |      |
| 12   | 当前故障fault | uint16_t | 0x0000 无故障；0x0001过压；0x0002 欠压；0x0004过载; 0x0008 过温; 0x0020 输出缺相; 0x0040 输出短路; 0x0080 风机堵转 |      |

## 4  举例

##### 4.1 下发指令1用于读取设备状态，下发指令2用于操作设备 。

上位机收到的指令1的回复，表示串口设备按照指令1执行后的运行状态，服务器需要这条数据。

上位机收到的指令2的回复，表示设备接收到了下发的指令，服务器不需要此数据。

##### 4.2 正式运行指令

4.2.1  服务器->上位机 00 00 00 01 01 21 10 00 00 00 03 06 00 02 00 02 00 00 41 E0 (帧头+指令2)(下发转速0)

4.2.2 上位机->串   口                              21 03 00 00 00 0D 42 AF (指令1)

​                                                                 21 10 00 00 00 03 06 00 02 00 02 00 00 41 E0  (指令2)                                                                  

指令1和指令2周期下发给串口 间隔1秒 类似:

09:00:00 指令1

09:00:01 指令2

09:00:02 指令1

09:00:03 指令2

09:00:04 指令1

09:00:05 指令2

------

4.2.3  串   口 ->上位机                            21 03 1A 00 03 00 02 00 00 FF E2 00 00 00 00 00 00 00 00 00 00 02 36 00 01 00 00 00 00 91 A7 (指令1回复) 

​                                                                 21 10 00 00 00 03 87 68(指令2回复)                                                               

注意 指令2的回复不需要，只需要指令1的回复， 类似:

09:00:00 指令1回复 //接收

09:00:01 指令2回复 //抛弃

09:00:02 指令1回复 //接收

09:00:03 指令2回复 //抛弃

09:00:04 指令1回复 //接收

09:00:05 指令2回复 //抛弃

4.2.4 上位机-> 服务器 00 00 00 01 01  21 03 1A 00 03 00 02 00 00 FF E2 00 00 00 00 00 00 00 00 00 00 02 36 00 01 00 00 00 00 91 A7 (帧头+指令1回复)

------

##### 4.3 备注

上位机和服务器之间的数据传输均为一次一条

上位机和串口设备之间的数据传输均为周期收发 





4.2.1 示例二                 00 00 00 01 01 21 10 00 00 00 03 06 00 02 00 02 03 E8 41 5E(帧头+指令2)(下发转速1000)

4.2.2 上位机->串   口                              21 03 00 00 00 0D 42 AF (指令1)

​                                                                 21 10 00 00 00 03 06 00 02 00 02 03 E8 41 5E  (指令2)                                                                  

指令1和指令2周期下发给串口 间隔1秒 类似:

09:00:00 指令1

09:00:01 指令2

09:00:02 指令1

09:00:03 指令2

09:00:04 指令1

09:00:05 指令2
