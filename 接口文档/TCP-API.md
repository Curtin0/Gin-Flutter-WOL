

# 上位机与服务器通信 TCP/IP

## 1  从站地址

上位机控制的串口设备的有效地址

风机控制器的地址范围为0x21~0x28，共8个连续的实际设备物理地址。

每个上位机连接8个风机控制器，风机控制器地址超过八个后无法区分，故数据上传服务器时需通过上位机ID+风机设备物理地址进行区分。

## 2 单帧格式

| 功能码说明 | 0x41表示正常运行;  0x0F表示初始化;  0x0E表示心跳包; 0x0D表示分配临时ID; 0x2B表示设备识别 |
| ---------- | ------------------------------------------------------------ |

### 2.1 服务器→上位机

| 分配ID(总12字节) | 帧头(上位机ID)          | 帧头(上位机模式)  | 从站地址          | 功能码   | 主协议版本 | 修订协议版本 | 参数长度 | 下发参数 | CRC16    | 帧尾   |
| ---------------- | ----------------------- | ----------------- | ----------------- | -------- | ---------- | ------------ | -------- | -------- | -------- | ------ |
| 描述   （例如）  | 0x00000001（见2.3列表） | 0x01（见2.3列表） | 0x00（见2.3列表） | **0x0D** | 0x01       | 0x00         | 0x00     | /        | 0xXXXX   | （空） |
| 长度   （byte）  | 4                       | 1                 | 1                 | 1        | 1          | 1            | 1        | 0（H-L） | 2（L-H） | 0      |

| 正式运行(总18字节) | 帧头(上位机ID)          | 帧头(上位机模式)  | 从站地址          | 功能码 | 主协议版本 | 修订协议版本 | 参数长度 | 下发参数      | 校验码   | 帧尾   |
| ------------------ | ----------------------- | ----------------- | ----------------- | ------ | ---------- | ------------ | -------- | ------------- | -------- | ------ |
| 描述   （例如）    | 0x00000001（见2.3列表） | 0x01（见2.3列表） | 0x21（见2.3列表） | 0x41   | 0x01       | 0x00         | 0x06     | （见2.3列表） | 0xXXXX   | （空） |
| 长度   （byte）    | 4                       | 1                 | 1                 | 1      | 1          | 1            | 1        | 6（H-L）      | 2（L-H） | 0      |

### 2.2 上位机→服务器

| 分配ID请求(总12字节) | 帧头(上位机ID) | 帧头(上位机模式)  | 从站地址          | 功能码   | 主协议版本 | 修订协议版本 | 参数长度 | 下发参数 | CRC16    | 帧尾   |
| -------------------- | -------------- | ----------------- | ----------------- | -------- | ---------- | ------------ | -------- | -------- | -------- | ------ |
| 描述   （例如）      | 0x00000000     | 0x01（见2.3列表） | 0x00（见2.3列表） | **0x0D** | 0x01       | 0x00         | 0x00     | /        | 0xXXXX   | （空） |
| 长度   （byte）      | 4              | 1                 | 1                 | 1        | 1          | 1            | 1        | 0（H-L） | 2（L-H） | 0      |

| 初始化(总12字节) | 帧头(上位机ID)          | 帧头(上位机网络状态) | 从站地址          | 功能码 | 主协议版本 | 修订协议版本 | 参数长度 | 上传参数 | 校验码   | 帧尾   |
| ---------------- | ----------------------- | -------------------- | ----------------- | ------ | ---------- | ------------ | -------- | -------- | -------- | ------ |
| 描述   （例如）  | 0x00000001（见2.4列表） | 0x01（见列2.4表）    | 0x21（见2.4列表） | 0x0F   | 0x01       | 0x00         | 0x00     | /        | 0xXXXX   | （空） |
| 长度   （byte）  | 4                       | 1                    | 1                 | 1      | 1          | 1            | 1        | 0        | 2（L-H） | 0      |

| 设备识别(总42字节) | 帧头                    | 帧头(上位机网络状态) | 从站地址 | 功能码   | 上传参数  | CRC16    | 帧尾   |
| ------------------ | ----------------------- | -------------------- | -------- | -------- | --------- | -------- | ------ |
| 描述   （例如）    | 0x00000001（见2.4列表） | 0x01（见2.4列表）    | 0x21     | **0x2B** | 见6.4列表 | 0xXXXX   | （空） |
| 长度   （byte）    | 4                       | 1                    | 1        | 1        | 33        | 2（L-H） | 0      |

| 正式运行(总50字节) | 帧头(上位机ID)          | 帧头(上位机网络状态) | 从站地址          | 功能码 | 主协议版本 | 修订协议版本 | 参数长度 | 上传参数      | 校验码   | 帧尾   |
| ------------------ | ----------------------- | -------------------- | ----------------- | ------ | ---------- | ------------ | -------- | ------------- | -------- | ------ |
| 描述   （例如）    | 0x00000001（见2.4列表） | 0x01（见2.4列表）    | 0x21（见2.4列表） | 0x41   | 0x01       | 0x00         | 0x26     | （见2.4列表） | 0xXXXX   | （空） |
| 长度   （byte）    | 4                       | 1                    | 1                 | 1      | 1          | 1            | 1        | 38（H-L）     | 2（L-H） | 0      |

| 心跳包(总12字节) | 帧头(上位机ID)          | 帧头(上位机网络状态) | 从站地址 | 功能码 | 主协议版本 | 修订协议版本 | 参数长度 | 上传参数 | 校验码   | 帧尾   |
| ---------------- | ----------------------- | -------------------- | -------- | ------ | ---------- | ------------ | -------- | -------- | -------- | ------ |
| 描述   （例如）  | 0x00000001（见2.4列表） | 0x01（见2.4列表）    | 0x00     | 0x0E   | 0x01       | 0x00         | 0x00     | /        | 0xXXXX   | （空） |
| 长度   （byte）  | 4                       | 1                    | 1        | 1      | 1          | 1            | 1        | 0        | 2（L-H） | 0      |

### 2.3 下发参数列表

| 序号 | 数据定义       | 数据类型 | 数据说明                                                     | 单位  |
| ---- | -------------- | -------- | ------------------------------------------------------------ | ----- |
| /    | 帧头 ID        | uint32_t | 0x00000001表示上位机ID (暂定最大值0x00000006, 共6个上位机)   |       |
| /    | 帧头上位机模式 | uint8_t  | 0x00手动模式；0x01自动模式                                   |       |
| /    | 从站地址       | uint8_t  | 0x21~0x28表示ID为1的上位机接入的8台风机设备的地址            |       |
| 1    | 输入源选择     | uint8_t  | 0x00  自动识别;  0x01 DC110V ; 0x02 DC600V ; 0x03  AC380V ;  |       |
| 2    | 运行模式       | uint8_t  | 0x00  停机 ;  0x01 执行设置转速参数调速  ;  0x02  根据风量等级进行调速 ; 0x03  0-10V电压调速 |       |
| 3    | 风量等级       | uint16_t | *0x0003* （3级风量）                                         | level |
| 4    | 设置转速       | int16_t  | *0x03E8（1000转），负数表示反转*                             | rpm   |

### 2.4 上传参数列表

| 序号 | 定义            | 类型     | 数据说明                                                     | 单位 |
| ---- | --------------- | -------- | ------------------------------------------------------------ | ---- |
| /    | 帧头 ID         | uint32_t | 0x00000001表示上位机ID (限定最大值0x00000064, 共100个上位机) |      |
| /    | 帧头上位机网络状态 | uint8_t  | 0x00网络掉线  0x01网络在线                                   |      |
| /    | 从站地址        | uint8_t  | 0x21~0x28表示ID为1的上位机接入的八台风机设备的地址           |      |
| / | 功能码 | uint8_t | 0x41 设备正常运行; 0x0F 用于检测设备在线情况 ; 0X0E用于心跳包 | |
| 1    | 当前状态status | uint32_t | 0x00000000 空闲；0x00000001 启动；0x00000002 运行；0x00000003 故障；0x00000004 故障死锁；0x00000005 停机 |      |
| 2    | 当前故障fault   | uint32_t | 0x00000000 无故障；0x00010000 过压；0x00020000 欠压；0x00040000 过载; 0x00080000 过温; 0x00200000 输出缺相; 0x00400000 输出短路; 0x00800000 风机堵转 |      |
| 3    | 输入源source    | uint8_t  | 0x00 未识别或者欠压; 0x01 DC110V; 0x02 DC600V; 0x03 AC380V   |      |
| 4    | 运行模式mode    | uint8_t  | 0x00 停机; 0x01 按“设置转速”运行;0x02 按“风量等级”运行; 0x03按“电压调速”运行 |      |
| 5    | 风机转速        | int16_t  | eg: 0x03E8（1000转）                                      | rpm  |
| 6    | NTC温度         | int16_t  | eg: 0x0028（40摄氏度）                                    | ℃    |
| 7    | 母线电压        | uint16_t | eg: 0x006E（110V）                                        | V    |
| 8    | U相电流         | uint16_t | eg: 0x0BB8（3000mA有效值）                                | mA   |
| 9    | V相电流         | uint16_t | eg: 0x0BB8（3000mA有效值）                                | mA   |
| 10   | W相电流         | uint16_t | eg: 0x0BB8（3000mA有效值）                                | mA   |
| 10.1 | X轴振动加速度 | int16_t | eg：0x0038(56mg) | mg |
| 10.2 | Y轴振动加速度 | int16_t | eg：0x0028(40mg) | mg |
| 10.3 | Z轴振动加速度 | int16_t | eg：0x0018(24mg) | mg |
| 10.4 | 加速度矢量和 | int16_t | eg:   0x0058(88mg) | mg |
| 11   | 运行时间        | uint32_t | *eg.:0x00004E20（20000s累计运行时间）*                       | s    |
| 12   | 软件版本        | Uint32_t | *eg.:0x00010203(版本号：V1.23)*                              |      |

### 2.5 运行流程

##### 总计七种指令

2.5.1 请求ID分配 -> 请求ID分配回复 -> 初始化 -> 设备识别 -> 正式运行(下发) ->正式运行(上传)

   即    3.4.1 ->           3.4.2   ->                 3.2.2  ->    6.5 ->          3.1.1 ->                 3.1.2

2.5.2 心跳包指令与2.5.1独立 ，周期产生。 即 3.3.1

## 3 示例

*-----------------------------------------------------------------------------------------------------------------------------------------*

### 3.1正常运行

#### 考虑和串口通信兼容，CRC16校验不包括帧头部分。即从第6个字节开始

#### 3.1.1 服务器指令下发：5(帧头)+13 =18个字节

HEX: 00 00 00 01 01 21 41 01 00 06 00 02 00 03 00 00 XX 99

表示下发给上位机ID为1, 自动模式,自动判断输入源，风量调节模式，3级风量,0转。

#### 3.1.2 上位机数据上传：5(帧头)+45 =50个字节

HEX:00 00 00 01 01 21 41 01 00 26 00 00 00 02 00 80 00 00 03 02 03 E8 00 28 00 6E 0B B8 0B B8 0B B8 00 38 00 28 00 18 00 58 00 00 4E 20 00 01 02 03 86 BC

表示上位机ID为1,网络在线  //串口设备物理地址0x21，运行状态，风量堵转，AC 380V电源输入，当前1000转，40摄氏度，母线110V，U相电流3000mA，V相电流3000mA，W相电流3000mA，*x轴振动值为56mg，y轴振动值为40mg，z轴振动值为25mg，加速度矢量和为88mg，*已运行20000s，软件版本为V1.23。

*-----------------------------------------------------------------------------------------------------------------------------------------*

### 3.2 初始化-设备在线检测

//CRC16校验包含帧头

#### 3.2.2 方向2:(不在线的也通知)   

上位机数据上传: 

00 00 00 01 01 21 0F 01 00 00 8F C5

00 00 00 01 01 27 0F 01 00 00 07 C5

00 00 00 01 00 22 0F 01 00 00 CA 14

00 00 00 01 00 23 0F 01 00 00 F7 D4

00 00 00 01 00 24 0F 01 00 00 42 14

00 00 00 01 00 25 0F 01 00 00 7F D4

00 00 00 01 00 26 0F 01 00 00 3B D4

00 00 00 01 00 28 0F 01 00 00 52 15

表示1号上位机连接的8台风机设备中,地址为0x21和地址为0x27的风机设备在线，其余设备不在线。

8帧数据需依次上传，每帧之间隔1秒，否则几帧会粘合在一起，不便解析。

#### 3.2.3 服务器回复:

服务器不需回复上位机。

*-----------------------------------------------------------------------------------------------------------------------------------------*

### 3.3 心跳包   周期15秒 

//CRC16校验包含帧头

#### 3.3.1上位机数据上传:  

00 00 00 01 01 00 0E 01 00 00 32 3E

表示1号上位机保持在线，

#### 3.3.2 服务器回复:

服务器不需回复上位机。

*-----------------------------------------------------------------------------------------------------------------------------------------*

### 3.4 分配临时ID

//CRC16校验包含帧头

#### 3.4.1上位机数据上传: 

00 00 00 00 01 00 0D 01 00 00 XX XX

表示上位机请求服务器分配临时ID

#### 3.4.2 服务器回复:

00 00 00 01 01 00 0D 01 00 00 XX XX

表示收到的临时ID为1

*-----------------------------------------------------------------------------------------------------------------------------------------*

## 4 端口

服务器端对上位机通信端口为 20019

服务器IP为112.74.182.249

## 5 当前故障fault解析解释:

实际为uint32，示范以uint8为例

设备故障定义

| 十六机制 | 二进制    | 含义     |
| -------- | --------- | -------- |
| 0x00     | 0000 0000 | 无故障   |
| 0x01     | 0000 0001 | 过压     |
| 0x02     | 0000 0010 | 欠压     |
| 0x04     | 0000 0100 | 过载     |
| 0x08     | 0000 1000 | 过温     |
| 0x20     | 0010 0000 | 输出缺相 |
| 0x40     | 0100 0000 | 输出短路 |
| 0x80     | 1000 0000 | 风机堵转 |

------

实际情况举例

| 十六进制 | 二进制    | 含义                                           |
| -------- | --------- | ---------------------------------------------- |
| 0x01     | 0000 0001 | 过压                                           |
| 0x81     | 1000 0001 | 风机堵转+过压                                  |
| 0x89     | 1000 1001 | 风机堵转+过温+过压                             |
| 0xEF     | 1110 1111 | 过压+欠压+过载+过温+输出缺相+输出短路+风机堵转 |

解决方法:

```c++
byte info=0xEF;
string str;

if(info&&0x00==0x00)
  str+="无故障"；

if(info&&0x01==0x01)
  str+="过压"；

if(info&&0x02==0x02)
  str+="欠压"；

if(info&&0x04==0x04)
  str+="过载"；

if(info&&0x08==0x08)
  str+="过温"；

if(info&&0x20==0x20)
  str+="输出缺相"；

if(info&&0x40==0x40)
  str+="输出短路"；

if(info&&0x80==0x80)
  str+="风机堵转"；

```

## 6 设备识别指令

### 6.4 上传参数

| 序号 | 定义             | 长度byte | 类型    | 数据说明                                           |
| ---- | ---------------- | -------- | ------- | -------------------------------------------------- |
| 1    | MEI类型          | 1        | uint8_t | eg:0x0E                                            |
| 2    | ReadDevID码      | 1        | uint8_t | eg:0x01                                            |
| 3    | 一致性等级       | 1        | uint8_t | eg:0x01 (一致性等级为1)                            |
| 4    | 随后更多         | 1        | uint8_t | eg:0x00 (随后更多为0)                              |
| 5    | 下一个对象ID     | 1        | uint8_t | eg:0x00 (无下一个对象ID)                           |
| 6    | 对象号           | 1        | uint8_t | eg:0x03 (本帧有3个对象号)                          |
| 7    | 对象ID的列表     | 1        | uint8_t | eg:0x00 (第0个对象)                                |
| 8    | 对象长度         | 1        | uint8_t | eg:0x06 (共6个字节)                                |
| 9    | 对象值(厂家信息) | 6        |         | eg:54 4F 4E 47 59 45(表示”TONGYE“)                 |
| 10   | 对象ID的列表     | 1        | uint8_t | eg:0x01 (第1个对象)                                |
| 11   | 对象长度         | 1        | uint8_t | eg:0x0A (共10个字节)                               |
| 12   | 对象值(设备型号) | 10       |         | eg:54 59 2E 50 4D 53 4D 31 30 41(表示"TY.PMSM10A") |
| 13   | 对象ID的列表     | 1        | uint8_t | eg:0x02 (第2个对象)                                |
| 14   | 对象长度         | 1        | uint8_t | eg:0x05 (共5个字节)                                |
| 15   | 对象值(版本)     | 5        |         | eg:56 31 2E 30 30(表示"V1.00")                     |

### 6.5  示例

------------------------------------------------------------------------------------------------

```
收←00 00 00 01 01 21 2B 0E 01 01 00 00 03 00 06 54 4F 4E 47 59 45 01 0A 54 59 2E 50 4D 53 4D 31 30 41 02 05 56 31 2E 30 30 5F B6
```

// 上位机ID为1，对应地址为0x21的设备  生产厂家为TONGYE，设备型号为TY.PMSM10A，设备程序版本为V1.00。    
