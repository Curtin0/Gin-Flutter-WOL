# 上位机与串口设备通信RS485

## 1  从站地址

上位机控制的串口设备的有效地址

风机控制器的地址范围为0x21~0x28，共8个连续的实际设备物理地址。

每个上位机连接8个风机控制器，风机控制器地址超过八个后无法区分，故数据上传服务器时需通过上位机ID+风机设备物理地址进行区分。

## 2  数据传输格式

### 2.1 上位机->串口设备

| 初始化(总5字节) | 帧头 | 固定格式 | 固定格式 | 从站地址        | 校验码   | 帧尾 |
| --------------- | ---- | -------- | -------- | --------------- | -------- | ---- |
| 描述            | (空) | 0x20     | 0x01     | 0x21（见1解释） | 0xXXXX   | (空) |
| 长度(byte)      | 0    | 1        | 1        | 1               | 2（L-H） | 0    |

| 设备识别(总7字节) | 帧头   | 从站地址        | 功能码 | 下发参数(无变量) | CRC16    | 帧尾   |
| ----------------- | ------ | --------------- | ------ | ---------------- | -------- | ------ |
| 描述   （例如）   | （空） | 0x21（见1解释） | 0x2B   | 见6.3列表        | 0xXXXX   | （空） |
| 长度   （byte）   | 0      | 1               | 1      | 3                | 2（L-H） | 0      |

| 正式运行(总13字节) | 帧头 | 从站地址        | 功能码 | 主协议版本 | 修订协议版本 | 参数长度 | 下发参数    | 校验码   | 帧尾   |
| ------------------ | ---- | --------------- | ------ | ---------- | ------------ | -------- | ----------- | -------- | ------ |
| 描述   （例如）    | (空) | 0x21（见1解释） | 0x41   | 0x01       | 0x00         | 0x06     | 见文件2列表 | 0xXXXX   | （空） |
| 长度   （byte）    | 0    | 1               | 1      | 1          | 1            | 1        | 6           | 2（L-H） | 0      |

### 2.2  串口设备->上位机

| 初始化(总5字节) | 帧头 | 固定格式 | 固定格式 | 从站地址        | 校验码 | 帧尾 |
| --------------- | ---- | -------- | -------- | --------------- | ------ | ---- |
| 描述            | (空) | 0x20     | 0x01     | 0x21（见1解释） | 0xXXXX | (空) |
| 长度(byte)      | 0    | 1        | 1        | 1               | 2      | 0    |

| 设备识别(总37字节) | 帧头   | 从站地址 | 功能码   | 上传参数  | CRC16    | 帧尾   |
| ------------------ | ------ | -------- | -------- | --------- | -------- | ------ |
| 描述   （例如）    | （空） | 0x21     | **0x2B** | 见6.4列表 | 0xXXXX   | （空） |
| 长度   （byte）    | 0      | 1        | 1        | 33        | 2（L-H） | 0      |

| 正式运行(总45字节) | 帧头 | 从站地址        | 功能码 | 主协议版本 | 修订协议版本 | 参数长度 | 上传参数    | 校验码   | 帧尾   |
| ------------------ | ---- | --------------- | ------ | ---------- | ------------ | -------- | ----------- | -------- | ------ |
| 描述   （例如）    | (空) | 0x21（见1解释） | 0x41   | 0x01       | 0x00         | 0x26     | 见文件2列表 | 0xXXXX   | （空） |
| 长度   （byte）    | 0    | 1               | 1      | 1          | 1            | 1        | 38（H-L）   | 2（L-H） | 0      |

------

## 3  数据传输流程

上位机对串口数据的处理

##### 3.0  分配临时ID                       上位机 -> 服务器 -> 上位机

##### 3.1  初始化指令                       上位机 -> 串口 -> 上位机 -> 服务器

##### 3.1.1 设备识别指令                 上位机 -> 串口 -> 上位机 -> 服务器

##### 3.2  正式运行指令  服务器 -> 上位机 -> 串口 -> 上位机 -> 服务器

##### 3.3  心跳包                                                             上位机 -> 服务器

上位机与服务器之间的数据格式见另一个接口文件

## 4  举例

##### 4.0 分配临时ID

4.0.1 上位机->服务器  00 00 00 00 01 00 0D 01 00 00 22 BA

4.0.1 服务器->上位机  00 00 00 01 01 00 0D 01 00 00 32 7A

##### 4.1 初始化指令

4.1.1  上位机->串   口  20 01 21 B1 82

4.1.2  串   口->上位机  20 01 21 B1 82

4.1.3 上位机->服务器  00 00 00 01 01 21 0F 01 00 00 8F C5

##### 4.1.4 设备识别指令(只对4.1中在线的设备检测)

4.1.5 上位机->串   口  21 2B 0E 01 00 F1 B0

4.1.6  串   口->上位机 21 2B 0E 01 01 00 00 03 00 06 54 4F 4E 47 59 45 01 0A 54 59 2E 50 4D 53 4D 31 30 41 02 05 56 31 2E 30 30 5F B6

4.1.7 上位机->服务器 00 00 00 01 01 21 2B 0E 01 01 00 00 03 00 06 54 4F 4E 47 59 45 01 0A 54 59 2E 50 4D 53 4D 31 30 41 02 05 56 31 2E 30 30 5F B6

##### 4.2 正式运行指令

4.2.1  服务器->上位机 00 00 00 01 01 21 41 01 00 06 00 02 00 03 00 00 18 99

4.2.1  上位机->串   口                             21 41 01 00 06 00 02 00 03 00 00 18 99

4.2.1  串   口 ->上位机                            21 41 01 00 26 00 00 00 02 00 80 00 00 03 02 03 E8 00 28 00 6E 0B B8 0B B8 0B B8 00 38 00 28 00 18 00 58 00 00 4E 20 00 01 02 03 86 BC

4.2.1 上位机-> 服务器 00 00 00 01 01 21 41 01 00 26 00 00 00 02 00 80 00 00 03 02 03 E8 00 28 00 6E 0B B8 0B B8 0B B8 00 38 00 28 00 18 00 58 00 00 4E 20 00 01 02 03 86 BC

##### 4.3 心跳包

4.3.1 上位机->服务器  00 00 00 01 01 00 0E 01 00 00 32 3E

------

## 5  数据传输解释

##### 5.1 注意:

4.1的数据是轮询传输的，参数为从站地址0x21~0x28，需要遍历8个地址的设备。

4.2是周期传输的，只针对1台设备周期下发和上传数据。

## 6 设备识别指令

### 6.3 下发参数

| 序号 | 定义        | 长度byte | 类型    | 数据说明             |
| ---- | ----------- | -------- | ------- | -------------------- |
| 1    | MEI类型     | 1        | uint8_t | eg:0x0E              |
| 2    | ReadDevID码 | 1        | uint8_t | eg:0x01              |
| 3    | 对象ID      | 1        | uint8_t | eg:0x00  (对象ID为0) |

### 6.4 上传参数

| 序号 | 定义             | 长度byte | 类型    | 数据说明                                           |
| ---- | ---------------- | -------- | ------- | -------------------------------------------------- |
| 1    | MEI类型          | 1        | uint8_t | eg:0x0E                                            |
| 2    | ReadDevID码      | 1        | uint8_t | eg:0x01                                            |
| 3    | 一致性等级       | 1        | uint8_t | eg:0x01 (一致性等级为1)                            |
| 4    | 随后更多         | 1        | uint8_t | eg:0x00 (随后更多为0)                              |
| 5    | 下一个对象ID     | 1        | uint8_t | eg:0x00 (无下一个对象ID)                           |
| 6    | 对象号           | 1        | uint8_t | eg:0x03 (本帧有3个对象号)                          |
| 7    | 对象ID的列表     | 1        | uint8_t | eg:0x00 (第0个对象)                                |
| 8    | 对象长度         | 1        | uint8_t | eg:0x06 (共6个字节)                                |
| 9    | 对象值(厂家信息) | 6        |         | eg:54 4F 4E 47 59 45(表示”TONGYE“)                 |
| 10   | 对象ID的列表     | 1        | uint8_t | eg:0x01 (第1个对象)                                |
| 11   | 对象长度         | 1        | uint8_t | eg:0x0A (共10个字节)                               |
| 12   | 对象值(设备型号) | 10       |         | eg:54 59 2E 50 4D 53 4D 31 30 41(表示"TY.PMSM10A") |
| 13   | 对象ID的列表     | 1        | uint8_t | eg:0x02 (第2个对象)                                |
| 14   | 对象长度         | 1        | uint8_t | eg:0x05 (共5个字节)                                |
| 15   | 对象值(版本)     | 5        |         | eg:56 31 2E 30 30(表示"V1.00")                     |

### 6.5  示例

```
发→21 2B 0E 01 00 F1 B0
```

查询设备地址为0x21的设备识别数据

------------------------------------------------------------------------------------------------

```
收←21 2B 0E 01 01 00 00 03 00 06 54 4F 4E 47 59 45 01 0A 54 59 2E 50 4D 53 4D 31 30 41 02 05 56 31 2E 30 30 5F B6
```

// 地址为0x21的设备生产厂家为TONGYE，设备型号为TY.PMSM10A，设备程序版本为V1.00。   
